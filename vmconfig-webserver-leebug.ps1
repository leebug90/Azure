# Allow ICMP
netsh advfirewall firewall add rule name="Allow ICMPv4" protocol=icmpv4:8,any dir=in action=allow
netsh advfirewall firewall add rule name="Allow ICMPv6" protocol=icmpv6:8,any dir=in action=allow

# Install IIS with ASP.Net support
Install-WindowsFeature -name Web-Server, Web-Asp-Net45 -IncludeManagementTools

# Create a default file containing WAN IP, ipconfig output, and a dump of request headers
$HTML = "<pre>" + $ENV:COMPUTERNAME + "<br/>"
$HTML += "WAN IP: $(irm ifconfig.me) <br/><hr/>"
$HTML += "Request headers: <br/>"
$HTML += '<%= Request.Headers.ToString().Replace("&","<br/>") %></pre>'
$HTML > C:\inetpub\wwwroot\default.aspx

# Install Certificate - leebug.biz
mkdir c:\Temp1
Add-Content -Value "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"  -Path C:\temp1\pfx-encoded-bytes.txt
certutil -decode c:\temp1\pfx-encoded-bytes.txt c:\temp1\backend.pfx
certutil -f -p poshacme -importpfx c:\temp1\backend.pfx

# Remove default iisstart.htm file
Remove-Item "C:\inetpub\wwwroot\iisstart.htm"

# Configure IIS HTTPS binding using previously imported self signed certificate
$Cert = Get-ChildItem Cert:\LocalMachine\My\ | ? Subject -eq "CN=backend.fabrikam.com"
New-WebBinding -Name "Default Web Site" -Protocol https -Port 443
(Get-WebBinding -Name "Default Web Site" -Protocol https -Port 443).AddSslCertificate($Cert.Thumbprint, "my")

# Remove http binding
Remove-WebBinding -Protocol http -Port 80
